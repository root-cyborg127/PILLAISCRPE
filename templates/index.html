<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* Modern Dark/Light Theme Variables */
        :root {
            --primary: #4f46e5; /* Indigo */
            --secondary: #22c55e; /* Green */
            --accent: #f97316; /* Orange */
            --dark-bg: #0f172a; /* Slate 900 */
            --light-bg: #ffffff;
            --card-dark: #1e293b; /* Slate 800 */
            --card-light: #f1f5f9; /* Slate 100 */
            --text-dark: #e2e8f0; /* Slate 200 */
            --text-light: #1e293b;
            --border-dark: rgba(255, 255, 255, 0.1);
            --border-light: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --card-bg: var(--card-dark);
            --text: var(--text-dark);
            --border: var(--border-dark);
        }
        [data-theme="light"] {
            --bg: var(--light-bg);
            --card-bg: var(--card-light);
            --text: var(--text-light);
            --border: var(--border-light);
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding-bottom: 75px;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary); /* Keep title color consistent for brand feel */
        }
        .theme-toggle {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            background: var(--card-bg);
            border: 1px solid var(--border);
        }

        /* Stats Grid - Cleaner, more contrast */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px var(--shadow-color); }
        .stat-icon { font-size: 1.8rem; margin-bottom: 10px; color: var(--primary); }
        .stat-number { font-size: 1.8rem; font-weight: bold; color: var(--accent); }
        .stat-label { font-size: 0.9rem; opacity: 0.7; }

        /* Student Grid - Instagram-like Cards */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        .student-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        .student-card:hover { border-color: var(--primary); transform: scale(1.02); }
        
        .student-header {
            display: flex; align-items: center; gap: 15px; margin-bottom: 15px;
        }
        .student-avatar {
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--primary);
            padding: 2px; /* Ring effect */
            background-color: var(--bg);
        }
        .student-info h3 { margin: 0; font-size: 1.2rem; color: var(--text); }
        .student-details { font-size: 0.9rem; opacity: 0.6; margin-top: 4px; }
        .student-meta {
            margin-top: auto; /* Push metadata to the bottom */
            padding-top: 15px;
            border-top: 1px dashed var(--border);
            font-size: 0.85rem;
            color: var(--secondary);
        }

        /* Modal / Biodata View - Best Presentable Way */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
        }
        .modal-content {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border-radius: 20px;
            max-width: 800px; width: 95%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 30px var(--shadow-color);
            padding: 0;
        }
        .close-btn { 
            position: sticky; top: 15px; right: 15px; 
            font-size: 1.5rem; cursor: pointer; color: var(--text); 
            z-index: 100; padding: 10px; border-radius: 50%; 
            background: var(--card-bg); border: 1px solid var(--border);
            align-self: flex-end; /* Align to the top-right corner within the container */
            margin: 10px 10px 0 0;
        }

        /* Biodata Specific Styling */
        #modalContent {
            display: flex;
            flex-direction: column;
        }
        .biodata-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
            background: var(--primary);
            color: white;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        .biodata-header img {
            width: 150px; height: 150px; border-radius: 50%; object-fit: cover;
            border: 5px solid white; margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .biodata-header h2 { margin: 0; font-size: 2rem; }
        .biodata-header p { opacity: 0.8; margin: 5px 0 0 0; font-size: 1rem; }

        .biodata-sections {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        .data-section h3 {
            color: var(--secondary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 5px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .data-item {
            display: flex;
            flex-direction: column;
            background: var(--bg); /* Use lighter background for contrast */
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .data-item label {
            font-weight: 600;
            font-size: 0.8rem;
            opacity: 0.6;
            margin-bottom: 2px;
        }
        .data-item span {
            font-size: 0.95rem;
            color: var(--text);
            word-break: break-word;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 70px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px var(--shadow-color);
            z-index: 900;
        }
        .bottom-nav button {
            background: none; border: none; color: var(--text);
            font-size: 1.2rem; display: flex; flex-direction: column;
            align-items: center; gap: 4px; cursor: pointer;
            transition: color 0.2s;
        }
        .bottom-nav button.active { color: var(--primary); }
        .bottom-nav button span { font-size: 0.75rem; }

        /* Logs */
        #logsPanel {
            background: #101010; /* Pure black/dark background for terminal look */
            color: #00ff00; /* Neon green text */
            border-radius: 12px;
            border: 1px solid var(--secondary);
            padding: 15px;
            margin-top: 20px;
            max-height: 50vh;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 1.5rem; }
            .modal-content { width: 95%; }
            .biodata-header img { width: 100px; height: 100px; }
            .biodata-sections { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-spider"></i> Student Scraper Dashboard</h1>
            <div class="theme-toggle" onclick="toggleTheme()">ðŸŒ™</div>
        </div>

        <div id="statsSection">
            <h2><i class="fas fa-chart-line"></i> Performance Stats</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div id="studentsSection">
            <h2><i class="fas fa-users"></i> Scraped Students</h2>
            <div class="students-grid" id="studentsGrid"></div>
        </div>

        <div id="logsPanel"></div>
    </div>

    <div class="modal" id="studentModal">
        <div class="modal-content">
            <i class="fas fa-times close-btn" onclick="closeModal()"></i>
            <div id="modalContent">
                </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button onclick="showSection('students')" id="navStudents"><i class="fas fa-users"></i><span>Students</span></button>
        <button onclick="showSection('stats')" id="navStats"><i class="fas fa-chart-line"></i><span>Stats</span></button>
        <button onclick="showSection('logs')" id="navLogs"><i class="fas fa-terminal"></i><span>Logs</span></button>
    </div>

    <script>
        let studentsSummary = [];
        const DEFAULT_IMG = 'https://via.placeholder.com/150/4f46e5/ffffff?text=NO+PIC';

        // --- Data Loading & Stats ---

        async function loadData() {
            // First, refresh the backend cache
            await fetch('/api/data_refresh');
            
            const [studentsRes, statsRes] = await Promise.all([
                fetch('/api/students'), fetch('/api/stats')
            ]);
            const students = await studentsRes.json();
            const stats = await statsRes.json();
            
            studentsSummary = students.students;
            updateStats(stats);
            displayStudents(studentsSummary);
        }

        function updateStats(stats) {
            document.getElementById("statsGrid").innerHTML = `
                <div class="stat-card">
                    <i class="fas fa-users stat-icon" style="color: var(--primary);"></i>
                    <div class="stat-number">${stats.total_students}</div>
                    <div class="stat-label">Total IDs Checked</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle stat-icon" style="color: var(--secondary);"></i>
                    <div class="stat-number">${stats.successful_scrapes}</div>
                    <div class="stat-label">Successful Scrapes</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-percent stat-icon" style="color: var(--accent);"></i>
                    <div class="stat-number">${stats.success_rate_percent}</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-alt stat-icon" style="color: var(--primary);"></i>
                    <div class="stat-number">${new Date(stats.last_updated).toLocaleTimeString()}</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            `;
        }

        // --- Student Grid Display ---

        function displayStudents(students) {
            const studentHTML = students.map(s => `
                <div class="student-card" onclick="openModal('${s.student_id}')">
                    <div class="student-header">
                        <img src="${s.image_url || DEFAULT_IMG}" onerror="this.src='${DEFAULT_IMG}'" class="student-avatar" alt="${s.student_name} Photo">
                        <div class="student-info">
                            <h3>${s.student_name || s.student_id}</h3>
                            <div class="student-details">${s.student_id}</div>
                        </div>
                    </div>
                    <div class="student-meta">
                        <i class="fas fa-book"></i> ${s.course_name}
                    </div>
                </div>
            `).join('');
            document.getElementById("studentsGrid").innerHTML = studentHTML;
        }

        // --- Student Detail Modal (Biodata View) ---

        async function openModal(studentId) {
            const modalContent = document.getElementById("modalContent");
            const studentModal = document.getElementById("studentModal");

            modalContent.innerHTML = `<div style="text-align: center; padding: 50px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading details...</p></div>`;
            studentModal.style.display = "flex";

            try {
                const response = await fetch(`/api/students/${studentId}`);
                if (!response.ok) throw new Error("Student details failed to load.");
                const student = await response.json();
                
                const biodataHTML = generateBiodataHTML(student);
                modalContent.innerHTML = biodataHTML;

            } catch (error) {
                console.error("Error loading student details:", error);
                modalContent.innerHTML = `<div style="text-align: center; padding: 50px; color: red;"><i class="fas fa-exclamation-triangle fa-2x"></i><p>${error.message}</p></div>`;
            }
        }

        function generateBiodataHTML(student) {
            const profile = student.profile_data || {};
            const sections = {
                'Personal Details': { icon: 'user-circle', details: profile.personal_details },
                'Admission Details': { icon: 'id-card', details: profile.admission_details },
                'Parent Details': { icon: 'user-friends', details: profile.parent_details },
                'Guardian Details': { icon: 'user-shield', details: profile.guardian_details },
                'Hostel Details': { icon: 'bed', details: profile.hostel_details },
                'Bank Details': { icon: 'university', details: profile.bank_details },
                'Mark Details': { icon: 'graduation-cap', details: profile.mark_details },
                'Other Details': { icon: 'ellipsis-h', details: profile.other_details },
            };

            let sectionsHTML = '';
            let totalDataPoints = 0;

            // Render all sections
            for (const [sectionName, sectionData] of Object.entries(sections)) {
                const details = sectionData.details;

                if (details && Object.keys(details).length > 0) {
                    // Filter details: Omit if value is null, empty string, or "0" (placeholder)
                    const filteredDetails = Object.entries(details).filter(([key, val]) => 
                        !key.startsWith('__') && 
                        val !== null && 
                        val !== "" && 
                        val !== "0" &&
                        val !== 0 // Ensure numeric zero is also filtered if it means 'missing'
                    );

                    if (filteredDetails.length > 0) {
                        totalDataPoints += filteredDetails.length;
                        let dataGridHTML = '';

                        // Sort keys alphabetically for stable layout
                        filteredDetails.sort(([keyA], [keyB]) => keyA.localeCompare(keyB));

                        for (const [key, value] of filteredDetails) {
                            // Clean the key: remove '*' and trim
                            const cleanKey = key.replace(/\*/g, '').trim(); 
                            
                            dataGridHTML += `
                                <div class="data-item">
                                    <label>${cleanKey}</label>
                                    <span>${value}</span>
                                </div>
                            `;
                        }

                        sectionsHTML += `
                            <div class="data-section">
                                <h3><i class="fas fa-${sectionData.icon}"></i> ${sectionName}</h3>
                                <div class="data-grid">${dataGridHTML}</div>
                            </div>
                        `;
                    }
                }
            }
            
            // Determine if any sections were rendered
            const isDataAvailable = totalDataPoints > 0;
            const fallbackMessage = '<div style="text-align: center; opacity: 0.7; padding: 20px;">No detailed, non-zero information available for this student.</div>';

            // Combine everything into the final modal structure
            return `
                <div class="biodata-header">
                    <img src="${student.image_url || DEFAULT_IMG}" onerror="this.src='${DEFAULT_IMG}'" alt="${student.student_name} Photo">
                    <h2>${student.student_name || 'Name Not Found'}</h2>
                    <p><strong>ID:</strong> ${student.student_id}</p>
                    <p><i class="fas fa-book-open"></i> ${profile.admission_details?.['Course Name'] || 'Course N/A'}</p>
                </div>
                <div class="biodata-sections">
                    ${isDataAvailable ? sectionsHTML : fallbackMessage}
                </div>
            `;
        }
        
        function closeModal() { document.getElementById("studentModal").style.display = "none"; }

        // --- UI/UX Functions ---

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute("data-theme");
            const isDark = current === "dark";
            html.setAttribute("data-theme", isDark ? "light" : "dark");
            document.querySelector(".theme-toggle").innerHTML = isDark ? 'ðŸŒ™' : '<i class="fas fa-sun"></i>';
        }

        // Section toggle
        function showSection(section) {
            document.getElementById("studentsSection").style.display = section === "students" ? "block" : "none";
            document.getElementById("statsSection").style.display = section === "stats" ? "block" : "none";
            document.getElementById("logsPanel").style.display = section === "logs" ? "block" : "none";
            
            document.querySelectorAll(".bottom-nav button").forEach(btn => btn.classList.remove("active"));
            document.getElementById("nav" + section.charAt(0).toUpperCase() + section.slice(1)).classList.add("active");
            
            // Auto refresh data when navigating back to students/stats
            if (section === "students" || section === "stats") {
                loadData();
            }
        }

        // Logs streaming
        function initLogs() {
            const evtSource = new EventSource("/api/logs");
            const panel = document.getElementById("logsPanel");

            evtSource.onmessage = function(event) {
                // Limit the number of lines to prevent memory issues
                const maxLines = 100;
                
                panel.innerHTML += event.data + "<br>";
                
                // Remove old lines if too long
                const lineBreaks = panel.innerHTML.split('<br>');
                if (lineBreaks.length > maxLines) {
                    panel.innerHTML = lineBreaks.slice(lineBreaks.length - maxLines).join('<br>');
                }

                panel.scrollTop = panel.scrollHeight;
            };
            
            evtSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                panel.innerHTML += `<div style="color: red;">[ERROR] Log stream disconnected. Retrying...</div><br>`;
            };
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check initial theme preference
            document.querySelector(".theme-toggle").innerHTML = document.documentElement.getAttribute("data-theme") === "dark" ? 'ðŸŒ™' : '<i class="fas fa-sun"></i>';
            
            loadData();
            initLogs();
            showSection("students"); // Default to students view
            
            // Refresh data periodically
            setInterval(loadData, 30000); 
        });
    </script>
</body>
</html>